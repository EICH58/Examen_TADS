@{
    ViewData["Title"] = "Gráfica de Pareto";
}

<link rel="stylesheet" href="~/css/graficas.css" />

<style>


</style>
<div class="grafica-container">

    <h2 class="grafica-titulo titulo">Gráfica de Pareto</h2>

    <!-- ===== FILTROS ===== -->
    <div class="filtros" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center;">
        <div class="sele">
        <label>Carrera:</label>
        <select id="carreraSelect" class="form-control">
            <option value="">-- Carrera --</option>
        </select>

        <label>Materia:</label>
        <select id="materiaSelect" class="form-control">
            <option value="">-- Materia --</option>
        </select>

        <label>Unidad:</label>
        <select id="unidadSelect" class="form-control">
            <option value="">-- Todas --</option>
        </select>

        <label>Modo:</label>
        <select id="modoSelect" class="form-control">
            <option value="ocurrencias">Ocurrencias</option>
            <option value="severidad">Severidad</option>
        </select>
        </div>

        <button id="btnCargarDatos" class="btn btn-primary">Cargar datos</button>
        <button id="btnExportarPDF" class="btn btn-success">Exportar PDF</button>
    </div>

    <!-- Encabezado dinámico -->
    <h5 id="encabezadoDatos" class="text-center text-secondary mt-3 mb-2"></h5>

    <!-- Toast -->
    <div id="toast" style="
        position: fixed; top: 20px; right: 20px;
        background: #0d6efd; color: #fff;
        padding: 12px 18px; border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,.2);
        display:none; z-index: 9999; font-weight:600;">
    </div>

    <!-- ===== GRÁFICA ===== -->
    <div class="contenedor-grafica"
         style="width:100%; max-width:900px; margin:0 auto;
                background:#fff; padding:18px; border-radius:12px;
                box-shadow:0 2px 8px rgba(0,0,0,.08); height:520px;">
        <canvas id="paretoCanvas" style="width:100% !important; height:100% !important;"></canvas>
    </div>

    <!-- ===== RESUMEN ===== -->
    <div id="resumen" class="bloque-interpretacion" style="margin-top:18px; max-width:900px; margin-left:auto; margin-right:auto;">
        <h4>Resumen</h4>
        <div id="tablaResumenContainer"></div>
    </div>

    <!-- ===== DESCRIPCIÓN ===== -->
    <div class="bloque-interpretacion" style="margin-top:16px; max-width:900px; margin-left:auto; margin-right:auto;">
        <h4>Información de la Gráfica</h4>
        <p>
            Este <strong>diagrama de Pareto</strong> muestra la <strong>distribución de factores de riesgo</strong> que afectan a los alumnos.
            Los factores están ordenados de mayor a menor <strong id="modoTexto">frecuencia</strong>, mostrando el <strong>porcentaje acumulado</strong> para identificar
            los factores más críticos. Puedes filtrar por <strong>Carrera</strong>, <strong>Materia</strong> y opcionalmente <strong>Unidad</strong>.
        </p>
        <div style="display:flex; justify-content:center; gap:30px; margin-top:15px; flex-wrap:wrap;">
            <div style="display:flex; align-items:center; gap:8px;">
                <div style="width:20px; height:20px; background:#e74c3c; border-radius:3px;"></div>
                <span><strong>Fisiológico</strong></span>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
                <div style="width:20px; height:20px; background:#f39c12; border-radius:3px;"></div>
                <span><strong>Pedagógico</strong></span>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
                <div style="width:20px; height:20px; background:#3498db; border-radius:3px;"></div>
                <span><strong>Psicológico</strong></span>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
                <div style="width:20px; height:20px; background:#2ecc71; border-radius:3px;"></div>
                <span><strong>Sociológico</strong></span>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ===== Toast =====
        function toast(msg, type="info") {
            const t = document.getElementById("toast");
            t.style.background = type==="error" ? "#dc3545" : type==="ok" ? "#198754" : "#0d6efd";
            t.textContent = msg;
            t.style.display = "block";
            clearTimeout(toast._h);
            toast._h = setTimeout(()=> t.style.display="none", 1800);
        }

        const RUTAS = {
            carreras: '/api/carreras',
            materias: id => `/api/materias/${id}`,
            unidades: id => `/api/unidades/${id}`,
            datos: '/api/pareto/factores'
        };

        async function poblar(url, sel, textKey, valueKey, includeTodas=false) {
            sel.innerHTML = includeTodas
                ? '<option value="">-- Todas --</option>'
                : `<option value="">-- ${sel.id.includes('carrera') ? 'Carrera' : 'Materia'} --</option>`;
            const r = await fetch(url);
            if (!r.ok) return;
            const data = await r.json();
            data.forEach(it => {
                const op = document.createElement('option');
                op.value = it[valueKey];
                op.textContent = it[textKey];
                sel.appendChild(op);
            });
        }

        async function initSelects() {
            const selC = document.getElementById('carreraSelect');
            const selM = document.getElementById('materiaSelect');
            const selU = document.getElementById('unidadSelect');

            await poblar(RUTAS.carreras, selC, 'nombre_Carrera', 'id_Carrera');
            selC.addEventListener('change', async () => {
                const idC = selC.value;
                selM.innerHTML = '<option value="">-- Materia --</option>';
                selU.innerHTML = '<option value="">-- Todas --</option>';
                if (idC) await poblar(RUTAS.materias(idC), selM, 'nombre_Materia', 'id_Materia');
            });

            selM.addEventListener('change', async () => {
                const idM = selM.value;
                selU.innerHTML = '<option value="">-- Todas --</option>';
                if (idM) await poblar(RUTAS.unidades(idM), selU, 'nombre_Unidad', 'id_Unidades', true);
            });

            // Actualizar texto según modo
            document.getElementById('modoSelect').addEventListener('change', () => {
                const modo = document.getElementById('modoSelect').value;
                document.getElementById('modoTexto').innerText = modo === 'severidad' ? 'severidad promedio' : 'frecuencia';
            });
        }

        const ctx = document.getElementById('paretoCanvas').getContext('2d');
        let chart = null;

        function getColorByFactor(factor) {
            const lower = factor.toLowerCase();
            if (lower.includes('fisiologico') || lower.includes('fisiológico')) return '#e74c3c';
            if (lower.includes('pedagogico') || lower.includes('pedagógico')) return '#f39c12';
            if (lower.includes('psicologico') || lower.includes('psicológico')) return '#3498db';
            if (lower.includes('sociologico') || lower.includes('sociológico')) return '#2ecc71';
            return '#95a5a6';
        }

        function renderChart(labels, data, modo) {
            if (chart) chart.destroy();

            // Calcular porcentaje acumulado
            const total = data.reduce((a, b) => a + b, 0);
            const cumulative = data.map((val, i) => {
                const sum = data.slice(0, i + 1).reduce((a, b) => a + b, 0);
                return ((sum / total) * 100).toFixed(1);
            });

            // Colores por factor
            const colors = labels.map(getColorByFactor);

            const yAxisLabel = modo === 'severidad' ? 'Severidad Promedio' : 'Número de Ocurrencias';

            chart = new Chart(ctx, {
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: modo === 'severidad' ? 'Severidad Promedio' : 'Ocurrencias',
                            data: data,
                            backgroundColor: colors,
                            borderColor: '#2c3e50',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            type: 'line',
                            label: '% Acumulado',
                            data: cumulative,
                            borderColor: '#8e44ad',
                            backgroundColor: '#8e44ad',
                            borderWidth: 2,
                            yAxisID: 'y1',
                            tension: 0.3,
                            pointRadius: 4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    if (context.dataset.type === 'line')
                                        return `Acumulado: ${context.raw}%`;
                                    return modo === 'severidad'
                                        ? `Severidad: ${context.raw}`
                                        : `Frecuencia: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Factores de Riesgo' },
                            grid: { display: false }
                        },
                        y: {
                            title: { display: true, text: yAxisLabel },
                            beginAtZero: true,
                            position: 'left'
                        },
                        y1: {
                            title: { display: true, text: '% Acumulado' },
                            beginAtZero: true,
                            max: 100,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { callback: (value) => value + '%' }
                        }
                    }
                }
            });
        }

        function renderResumen(labels, data, modo) {
            const total = data.reduce((a, b) => a + b, 0);
            const factorPrincipal = labels[0] || 'N/A';
            const valorPrincipal = data[0] || 0;

            const porcentaje = total ? ((valorPrincipal / total) * 100).toFixed(1) : '0.0';

            const etiquetaTotal = modo === 'severidad' ? 'Severidad total' : 'Total ocurrencias';
            const etiquetaValor = modo === 'severidad' ? 'Severidad' : 'Ocurrencias';

            document.getElementById('tablaResumenContainer').innerHTML = `
                <table class="table table-striped table-bordered text-center">
                    <thead class="table-dark">
                        <tr>
                            <th>${etiquetaTotal}</th>
                            <th>Factor principal</th>
                            <th>${etiquetaValor}</th>
                            <th>% del total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${modo === 'severidad' ? total.toFixed(2) : total}</td>
                            <td style="font-weight:600;">${factorPrincipal}</td>
                            <td>${modo === 'severidad' ? valorPrincipal.toFixed(2) : valorPrincipal}</td>
                            <td>${porcentaje}%</td>
                        </tr>
                    </tbody>
                </table>`;
            renderChart(labels, data, modo);
        }

        function actualizarEncabezado() {
            const cSel = document.getElementById('carreraSelect');
            const mSel = document.getElementById('materiaSelect');
            const uSel = document.getElementById('unidadSelect');
            const enc = document.getElementById('encabezadoDatos');

            const cTxt = cSel.value ? cSel.options[cSel.selectedIndex].text : "";
            const mTxt = mSel.value ? mSel.options[mSel.selectedIndex].text : "";
            const uTxt = uSel.value ? uSel.options[uSel.selectedIndex].text : "";

            if (!cSel.value) enc.innerText = "Distribución general de factores de riesgo";
            else enc.innerText = `${cTxt}${mTxt ? " – " + mTxt : ""}${uTxt ? " – " + uTxt : ""}`;
        }

        async function cargarDatos() {
            const idC = document.getElementById('carreraSelect').value;
            const idM = document.getElementById('materiaSelect').value;
            const idU = document.getElementById('unidadSelect').value;
            const modo = document.getElementById('modoSelect').value;

            if (!idC && (idM || idU)) {
                toast("Primero selecciona una Carrera.", "error");
                return;
            }

            const params = new URLSearchParams();
            if (idC) params.append('idCarrera', idC);
            if (idM) params.append('idMateria', idM);
            if (idU) params.append('idUnidad', idU);
            params.append('modo', modo);

            try {
                const url = `${RUTAS.datos}?${params}`;
                const r = await fetch(url);
                if (!r.ok) throw new Error();
                const result = await r.json();

                if (!result.labels || !result.labels.length) {
                    toast("No hay datos para esos filtros.", "error");
                    return;
                }

                actualizarEncabezado();
                renderResumen(result.labels, result.data, modo);
                toast("Datos cargados correctamente.", "ok");
            } catch {
                toast("Error al cargar datos.", "error");
            }
        }

        // ===== EXPORTAR PDF =====
        document.getElementById('btnExportarPDF').addEventListener('click', async () => {
            try {
                const canvas = document.getElementById('paretoCanvas');
                const imagenBase64 = canvas.toDataURL('image/png');
                const tablaHTML = document.getElementById('tablaResumenContainer').outerHTML;
                const encabezado = document.getElementById('encabezadoDatos').innerText;

                const datos = {
                    Titulo: "Gráfica de Pareto (Factores de Riesgo)",
                    Descripcion: encabezado || "Distribución general de factores de riesgo",
                    ImagenBase64: imagenBase64,
                    TablaHTML: tablaHTML,
                    Prefijo: "G_Pareto"
                };

                const resp = await fetch('/api/exportar/pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const contentType = resp.headers.get("Content-Type");

                if (contentType && contentType.includes("application/pdf")) {
                    const blob = await resp.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "G_Pareto.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    toast("PDF generado correctamente.", "ok");
                } else {
                    const resultado = await resp.json();
                    toast(resultado.error || "Error al generar el PDF.", "error");
                }
            } catch (err) {
                console.error(err);
                toast("Error al exportar PDF.", "error");
            }
        });

        document.getElementById('btnCargarDatos').addEventListener('click', cargarDatos);
        (async () => { await initSelects(); await cargarDatos(); })();
    </script>
}