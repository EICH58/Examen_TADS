@{
    ViewData["Title"] = "Gráfica de Pastel";
}

<link rel="stylesheet" href="~/css/Genera.css" />

<div class="contenido">
    <div class="cont">
        <h1 class="titulo">Gráfica de Aprobación</h1>

        <div class="filtros">
            <label>Carrera:</label>
            <select id="carreraSelect" class="form-control" style="width:220px;">
                <option value="">-- Carrera --</option>
            </select>

            <label>Materia:</label>
            <select id="materiaSelect" class="form-control" style="width:220px;">
                <option value="">-- Materia --</option>
            </select>

            <label>Unidad:</label>
            <select id="unidadSelect" class="form-control" style="width:220px;">
                <option value="">-- Unidad --</option>
            </select>

            <button id="btnCargar" class="btn btn-primary">Cargar Datos</button>
            <button id="btnExportar" class="btn btn-secondary">Exportar PDF</button>
        </div>

        <div class="grafica-container text-center mt-4">
            <canvas id="graficoPastel" width="500" height="300"></canvas>
        </div>

        <div class="descripcion mt-4">
            <h3>Distribución de Aprobación</h3>
            <p>
                Este gráfico muestra la proporción de alumnos <b>aprobados y reprobados</b> (≥70 requerido para aprobar).
            </p>
            <ul>
                <li><b>Aprobado (≥70)</b>: promedio igual o mayor a 70.</li>
                <li><b>Reprobado (&lt;70)</b>: promedio menor a 70.</li>
            </ul>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let chart;

    document.getElementById("btnCargar").addEventListener("click", async () => {
        const idCarrera = document.getElementById("carreraSelect").value || "";
        const idMateria = document.getElementById("materiaSelect").value || "";
        const idUnidad = document.getElementById("unidadSelect").value || "";

        const url = `/Graficas/GetDatosPastel?idCarrera=${idCarrera}&idMateria=${idMateria}&idUnidad=${idUnidad}`;

        const response = await fetch(url);
        const result = await response.json();

        if (chart) chart.destroy();

        const ctx = document.getElementById("graficoPastel").getContext("2d");
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: result.labels,
                datasets: [{
                    data: result.data,
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Distribución de Aprobados vs Reprobados'
                    }
                }
            }
        });
    });
</script>
