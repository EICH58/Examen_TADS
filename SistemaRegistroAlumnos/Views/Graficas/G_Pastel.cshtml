@{
    ViewData["Title"] = "Gráfica de Pastel";
}
<link rel="stylesheet" href="~/css/graficas.css" />

<div class="grafica-container">

    <h2 class="grafica-titulo titulo">Gráfica de Pastel</h2>

    <!-- ===== FILTROS ===== -->
    <div class="filtros" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center;">
        <label>Carrera:</label>
        <select id="carreraSelect" class="form-control" style="width:240px;">
            <option value="">-- Carrera --</option>
        </select>

        <label>Materia:</label>
        <select id="materiaSelect" class="form-control" style="width:240px;">
            <option value="">-- Materia --</option>
        </select>

        <label>Unidad:</label>
        <select id="unidadSelect" class="form-control" style="width:200px;">
            <option value="">-- Todas --</option>
        </select>

        <button id="btnCargarDatos" class="btn btn-primary">Cargar datos</button>
        <button id="btnExportarPDF" class="btn btn-success">Exportar PDF</button>
    </div>

    <!-- Encabezado dinámico -->
    <h5 id="encabezadoDatos" class="text-center text-secondary mt-3 mb-2"></h5>

    <!-- Toast -->
    <div id="toast" style="
        position: fixed; top: 20px; right: 20px;
        background: #0d6efd; color: #fff;
        padding: 12px 18px; border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,.2);
        display:none; z-index: 9999; font-weight:600;">
    </div>

    <!-- ===== GRÁFICA ===== -->
    <div class="contenedor-grafica"
         style="width:100%; max-width:900px; margin:0 auto;
                background:#fff; padding:18px; border-radius:12px;
                box-shadow:0 2px 8px rgba(0,0,0,.08); height:520px;">
        <canvas id="pastelCanvas" style="width:100% !important; height:100% !important;"></canvas>
    </div>

    <!-- ===== RESUMEN ===== -->
    <div id="resumen" class="bloque-interpretacion" style="margin-top:18px; max-width:900px; margin-left:auto; margin-right:auto;">
        <h4>Resumen</h4>
        <div id="tablaResumenContainer"></div>
    </div>

    <!-- ===== DESCRIPCIÓN ===== -->
    <div class="bloque-interpretacion" style="margin-top:16px; max-width:900px; margin-left:auto; margin-right:auto;">
        <h4>Porcentaje de aprobación y reprobación</h4>
        <p>
            Este diagrama de pastel muestra el <strong>porcentaje de aprobación y reprobación</strong> de los alumnos.
            Se considera <strong>aprobado</strong> con calificación <strong>≥ 70</strong> y <strong>reprobado</strong> con <strong>&lt; 70</strong>.
            Puedes filtrar por <strong>Carrera</strong>, <strong>Materia</strong> y opcionalmente <strong>Unidad</strong>.
        </p>
        <div style="display:flex; justify-content:center; gap:30px; margin-top:15px; flex-wrap:wrap;">
            <div style="display:flex; align-items:center; gap:8px;">
                <div style="width:20px; height:20px; background:#2ecc71; border-radius:3px;"></div>
                <span><strong>Aprobado (≥70)</strong></span>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
                <div style="width:20px; height:20px; background:#e74c3c; border-radius:3px;"></div>
                <span><strong>Reprobado (&lt;70)</strong></span>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ===== Toast =====
        function toast(msg, type="info") {
            const t = document.getElementById("toast");
            t.style.background = type==="error" ? "#dc3545" : type==="ok" ? "#198754" : "#0d6efd";
            t.textContent = msg;
            t.style.display = "block";
            clearTimeout(toast._h);
            toast._h = setTimeout(()=> t.style.display="none", 1800);
        }

        const RUTAS = {
            carreras: '/api/carreras',
            materias: id => `/api/materias/${id}`,
            unidades: id => `/api/unidades/${id}`,
            datos: '/api/pastel/calificaciones'
        };

        async function poblar(url, sel, textKey, valueKey, includeTodas=false) {
            sel.innerHTML = includeTodas
                ? '<option value="">-- Todas --</option>'
                : `<option value="">-- ${sel.id.includes('carrera') ? 'Carrera' : 'Materia'} --</option>`;
            const r = await fetch(url);
            if (!r.ok) return;
            const data = await r.json();
            data.forEach(it => {
                const op = document.createElement('option');
                op.value = it[valueKey];
                op.textContent = it[textKey];
                sel.appendChild(op);
            });
        }

        async function initSelects() {
            const selC = document.getElementById('carreraSelect');
            const selM = document.getElementById('materiaSelect');
            const selU = document.getElementById('unidadSelect');

            await poblar(RUTAS.carreras, selC, 'nombre_Carrera', 'id_Carrera');
            selC.addEventListener('change', async () => {
                const idC = selC.value;
                selM.innerHTML = '<option value="">-- Materia --</option>';
                selU.innerHTML = '<option value="">-- Todas --</option>';
                if (idC) await poblar(RUTAS.materias(idC), selM, 'nombre_Materia', 'id_Materia');
            });

            selM.addEventListener('change', async () => {
                const idM = selM.value;
                selU.innerHTML = '<option value="">-- Todas --</option>';
                if (idM) await poblar(RUTAS.unidades(idM), selU, 'nombre_Unidad', 'id_Unidades', true);
            });
        }

        const ctx = document.getElementById('pastelCanvas').getContext('2d');
        let chart = null;

        function calcularAprobadosReprobados(valores) {
            const aprobados = valores.filter(v => v >= 70).length;
            const reprobados = valores.filter(v => v < 70).length;
            return { aprobados, reprobados };
        }

        function renderChart(aprobados, reprobados) {
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Aprobado (≥70)', 'Reprobado (<70)'],
                    datasets: [{
                        data: [aprobados, reprobados],
                        backgroundColor: ['#2ecc71', '#e74c3c'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 14 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.raw;
                                    const percentage = total ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${value} alumnos (${percentage}%)`;
                                }
                            }
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }

        function renderResumen(valores) {
            const { aprobados, reprobados } = calcularAprobadosReprobados(valores);
            const total = valores.length;
            const promedio = total ? (valores.reduce((a,b)=>a+Number(b),0)/total).toFixed(2) : '—';
            const porcentajeAprobacion = total ? ((aprobados / total) * 100).toFixed(1) : '0.0';

            document.getElementById('tablaResumenContainer').innerHTML = `
                <table class="table table-striped table-bordered text-center">
                    <thead class="table-dark">
                        <tr>
                            <th>Total alumnos</th>
                            <th>Promedio general</th>
                            <th>Aprobados</th>
                            <th>Reprobados</th>
                            <th>% Aprobación</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${total}</td>
                            <td>${promedio}</td>
                            <td style="color:#2ecc71; font-weight:600;">${aprobados}</td>
                            <td style="color:#e74c3c; font-weight:600;">${reprobados}</td>
                            <td style="font-weight:600;">${porcentajeAprobacion}%</td>
                        </tr>
                    </tbody>
                </table>`;
            renderChart(aprobados, reprobados);
        }

        function actualizarEncabezado() {
            const cSel = document.getElementById('carreraSelect');
            const mSel = document.getElementById('materiaSelect');
            const uSel = document.getElementById('unidadSelect');
            const enc = document.getElementById('encabezadoDatos');

            const cTxt = cSel.value ? cSel.options[cSel.selectedIndex].text : "";
            const mTxt = mSel.value ? mSel.options[mSel.selectedIndex].text : "";
            const uTxt = uSel.value ? uSel.options[uSel.selectedIndex].text : "";

            if (!cSel.value) enc.innerText = "Distribución general de todos los alumnos";
            else enc.innerText = `${cTxt}${mTxt ? " – " + mTxt : ""}${uTxt ? " – " + uTxt : ""}`;
        }

        async function cargarDatos() {
            const idC = document.getElementById('carreraSelect').value;
            const idM = document.getElementById('materiaSelect').value;
            const idU = document.getElementById('unidadSelect').value;

            if (!idC && (idM || idU)) {
                toast("Primero selecciona una Carrera.", "error");
                return;
            }

            const params = new URLSearchParams();
            if (idC) params.append('idCarrera', idC);
            if (idM) params.append('idMateria', idM);
            if (idU) params.append('idUnidad', idU);

            try {
                const url = params.toString() ? `${RUTAS.datos}?${params}` : RUTAS.datos;
                const r = await fetch(url);
                if (!r.ok) throw new Error();
                const valores = await r.json();

                if (!valores.length) {
                    toast("No hay datos para esos filtros.", "error");
                    return;
                }

                actualizarEncabezado();
                renderResumen(valores);
                toast("Datos cargados correctamente.", "ok");
            } catch {
                toast("Error al cargar datos.", "error");
            }
        }

        // ===== EXPORTAR PDF =====
        document.getElementById('btnExportarPDF').addEventListener('click', async () => {
            try {
                const canvas = document.getElementById('pastelCanvas');
                const imagenBase64 = canvas.toDataURL('image/png');
                const tablaHTML = document.getElementById('tablaResumenContainer').outerHTML;
                const encabezado = document.getElementById('encabezadoDatos').innerText;

                const datos = {
                    Titulo: "Gráfica de Pastel (Aprobados vs Reprobados)",
                    Descripcion: encabezado || "Distribución general de todos los alumnos",
                    ImagenBase64: imagenBase64,
                    TablaHTML: tablaHTML,
                    Prefijo: "G_Pastel"
                };

                const resp = await fetch('/api/exportar/pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const contentType = resp.headers.get("Content-Type");

                if (contentType && contentType.includes("application/pdf")) {
                    const blob = await resp.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "G_Pastel.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    toast("PDF generado correctamente.", "ok");
                } else {
                    const resultado = await resp.json();
                    toast(resultado.error || "Error al generar el PDF.", "error");
                }
            } catch (err) {
                console.error(err);
                toast("Error al exportar PDF.", "error");
            }
        });

        document.getElementById('btnCargarDatos').addEventListener('click', cargarDatos);
        (async () => { await initSelects(); await cargarDatos(); })();
    </script>
}